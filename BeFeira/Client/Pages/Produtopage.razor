@page "/produtopage"
@page "/produtopage/{idsubcategoria:int}/{idstand:int}/{idfeira:int}/{idcliente:int}"

@inject ICarrinhoProdService CarrinhoProdService
@inject IProdutoService ProdutoService
@inject IClienteService ClientService
@inject IStandService StandService
@inject ISubcatserv SubcatService

@inject ICarrinhoService CarrinhoService

@inject NavigationManager  NavigationManager




<header>
    <link rel="stylesheet" href="icons/icons/css/all.css">
    <link rel="stylesheet" href="css/mainpage.css">

    <img src="logo.png" @onclick="(()=>gomain())" alt="BeFeira Logo">
    <div class="user_header_info">
        <h1>@name</h1>
        <i class="fa-solid fa-cart-shopping"@onclick="(()=>ShowKart())"></i>
    </div>
    <button class="u"><i class="fa-solid fa-circle-user" @onclick="(()=>gouser())" alt=""></i></button>
</header>


<body class="produtos_stand_container">

    <h1 class="products_stand_name">@String.Format("{0} - {1}", @standname, @subcatname)</h1>

    <div class="lista_produtos">
        
        @foreach (var produto in prods)
        {
        <div class="produto_basic_info">
            <img src="@produto.urlImage" alt="Imagem do produto">
            <p class="nome_produto">@produto.Nome_Produto</p>
            <p class="preco_produto">@String.Format("Preço: {0}€",produto.Preco.ToString("0.00"))</p>
            <p class="stock_produto">Disponível</p> <!--se stock > 0-->
            <div class="produto_basic_info_buttons">
                    <button><i class="fa-solid fa-circle-info"@onclick="(()=>showProdInfo((int)idsubcategoria,produto.ID))"></i></button>
                    <button><i class="fas fa-shopping-cart" @onclick="(()=>addtokart(produto))"></i></button>
            </div>
            
        </div>
        }

    </div>

    <button class="botao_voltar_bottom"@onclick="(()=>goback())">Voltar</button>

</body>

@code{
    List<Produto> prods = new List<Produto>();


    [Parameter]
    public int? idfeira { get; set; }

    [Parameter]
    public int? idstand { get; set; }

    [Parameter]
    public int? idsubcategoria { get; set; }


    [Parameter]
    public int? idcliente { get; set; }

    private Stand s;
    private Subcategoria sc;
    public string name;
    public string standname;
    public string subcatname;
    private int k;
    public Cliente c;


    protected override async Task OnInitializedAsync()
    {
        await CarrinhoService.getCarrinhos();
        await ProdutoService.GetProdutos();
        if (idcliente == -1) name = "Guest";
        else
        {
            c = await ClientService.GetSingleCliente((int)idcliente);
            name = c.Username;
            k= await CarrinhoService.ExistsCarrinho((int)idcliente);

        }
        s = await StandService.GetSingleStand((int)idstand);
        standname = s.Nome;
        sc = await SubcatService.GetSingleSubCat((int)idsubcategoria);
        subcatname = sc.Descricao;
    }



    protected override async Task OnParametersSetAsync()
    {
        if (idsubcategoria == null)
        {

        }
        else
        {
            prods = await ProdutoService.GetProdutosBySubcat((int)idsubcategoria);
        }
    }

    // Código para testar

    string nome_da_stand = "<Nome da Stand>";
    string nome_da_subcategoria = "<Subcategoria>";


    async void addtokart(Produto p)
    {
        if (idcliente!=-1){
        if (k > 0)
        {
            CarrinhoProduto a = new CarrinhoProduto { CarrinhoID = k, ProdutoID = p.ID, Quantidade = 1, Preco = p.Preco, TaxaBefeira = 10 };
            await CarrinhoProdService.AddCarrinhoProduto(a);

        }
        else
        {
            Carrinho novo = new Carrinho { ClienteID = idcliente, Total = 0};
            await CarrinhoService.AddCarrinho(novo);
            k = await CarrinhoService.ExistsCarrinho((int)idcliente);
            CarrinhoProduto a = new CarrinhoProduto { CarrinhoID = k, ProdutoID = p.ID, Quantidade = 1, Preco = p.Preco, TaxaBefeira = 10 };
        }
        }
    }

    void goback()
    {
        NavigationManager.NavigateTo($"standpage/{idfeira}/{idstand}/{idcliente}");
    }

    void gomain()
    {
        NavigationManager.NavigateTo($"mainpage/{idcliente}");
    }

    void showProdInfo(int subcat, int prod)
    {
        NavigationManager.NavigateTo($"produtoinfo/{prod}/{subcat}/{idstand}/{idfeira}/0/{idcliente}");
    }

    void gouser()
    {
        NavigationManager.NavigateTo($"userinfo/{idcliente}");
    }


    void ShowKart()
    {
        NavigationManager.NavigateTo($"/carrinhopage/{idcliente}/{idfeira}/{idstand}/{idsubcategoria}/produtopage");
    }

}